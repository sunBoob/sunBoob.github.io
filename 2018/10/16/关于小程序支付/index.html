<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="SunBoBo"><link rel="alternative" href="/atom.xml" title="SunBoBo" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>关于小程序支付 - SunBoBo</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0;"><header class="head"><h1 class="head-title u-fl"><a href="/">SunBoBo</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Catalog（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-10-15T16:00:00.000Z">October 16, 2018</time><h1 class="post__title"><a href="/2018/10/16/关于小程序支付/">关于小程序支付</a></h1><div class="post__main echo"><h3 id="关于小程序支付"><a href="#关于小程序支付" class="headerlink" title="关于小程序支付"></a>关于小程序支付</h3><h4 id="一、小程序支付有两个渠道。"><a href="#一、小程序支付有两个渠道。" class="headerlink" title="一、小程序支付有两个渠道。"></a>一、小程序支付有两个渠道。</h4><p>​    <strong>1、通过关联公众号开通支付</strong></p>
<p>​        这种方法是最常用，最普遍的用法，大家都知道，一个小程序只能关联一个公众号，但是一个公                       众号下却可以关联几百个小程序，也就是说，当我们为一这个公众号开通微信认证的时候，那么这个公众号下面的小程序都可以完成认证。不需要每个都花300块去做微信认证了，走那么多繁琐的逻辑。提交那么多繁琐的资料了，所以大部分都运用这个方法来给微信小程序开通支付功能。</p>
<p>​    <strong>2、小程序单独开通支付</strong></p>
<p>​        这种方法呢，就比较少见了，大多都是一些，可能我只需要一个小程序就可以了，不需要做更多的小程序了，这个时候，开通一个就可以了，所以这样的开通方式也是存在的 。</p>
<h4 id="二、开通流程"><a href="#二、开通流程" class="headerlink" title="二、开通流程"></a>二、开通流程</h4><p>​    不管是用那个方式开通，首先第一步都是需要进行微信认证的 ，也就是根据微信需要的提供营业执照，微信认证公函，等一系列的资料，然后微信会进行审核，审核通过后，微信认证就开通，</p>
<p>​    <em>微信认证开通，可以在微信公众平台，小程序左侧列表中找到<strong>**微信支付</strong></em>，<em>四个字，然后点击进去之后，就会看到开通微信认证等字样，按照上面的需要的资料提供资料就可以了，他怎么说就怎么做</em></p>
<p>​    开通了微信认证之后呢，下一步就要对账户进行验证，也都会标识在微信支付的那个界面中。（<strong>这里要注意一点，因为微信需要为你的对公账户打款，来验证你的账户的真实性，和准确性，所以，在之后的验证中，就需要你填写一下他给你打了多少款，比如说他给你打了0.48，你就要准确的把这金额填写上去，否则会验证失败，所以建议提前做好短信提醒等</strong>）</p>
<h4 id="三、注册商户号"><a href="#三、注册商户号" class="headerlink" title="三、注册商户号"></a>三、注册商户号</h4><p>​    好的，都弄好了，并且都通过了验证成功了之后。就需要开始注册商户号。商户号的注册至关重要，而且要比微信认证上传的填写的资料还要多。你尽量把可能用到的东西都准备好，（<em>无非就是对公账户，身份证号，电话，邮箱，营业执照等等 一些列的比较基础的信息</em>），准备好后开始注册商户号。也是有一个审核阶段的 ，这个阶段可能一两天左右。</p>
<h4 id="四、修改微信支付中的api秘钥"><a href="#四、修改微信支付中的api秘钥" class="headerlink" title="四、修改微信支付中的api秘钥"></a>四、修改微信支付中的api秘钥</h4><p>​    有人说了api秘钥是啥啊？呵呵，这TM就是个坑，他都快坑死我了，弄的我是神魂颠倒啊。他的作用至关重要，就是在你之后做微信支付的时候，需要一个签名，稍后我们再说签名的问题。先说这个api秘钥，首先登陆，微信支付的网址（<em>pay.weixin.qq.com</em>），登陆你的商户号。如果你已经和你的微信绑定了的话，直接扫码登陆就可以，如果没有你还需要绑定一下，绑定了之后再登陆。然后嘞，就是进入到首页，首页中有个导航栏上，有个账户安全。点进去，然后就会在左侧的导航栏中找到，api安全。对，点进去你就会发现他让你申请安全认证，好的申请，这个操作就简单了，输入操作密码，然后点击发送短信验证码，然后把验证码输入上去就可以了，然后获取到了安全认证之后。再设置api秘钥。秘钥设置成功之后，记得保存下来。自己记号，别弄丢了，或是告诉别人。这是属于资金交易的东西，很重要的。</p>
<h4 id="五、开发，获取参数"><a href="#五、开发，获取参数" class="headerlink" title="五、开发，获取参数"></a>五、开发，获取参数</h4><p>​    好了好了，终于一切都搞定了，这个是你就会发现，你的噩梦才刚刚来临。要想吊起支付窗口，还有一系列的繁琐的过程。首先就是需要参数，首先你要登录，调用接口获取登录凭证（code）进而换取用户登录态信息，包括用户的唯一标识（openid） 及本次登录的 会话密钥（session_key）等。用户数据的加解密通讯需要依赖会话密钥完成。这个登录不是像你登录微信的意思，而是相当于一道门，进了这道门你才能获取到第一个重要信息，就是登录凭证，一个code。然后再通过这个code，访问你自己小程序的的后台，调取接口，拿到openid 和session_key。而这个code，就是进门的第一步。相当于门牌号的意思吧。而openid 和session_key，就相当于你已经打开门了。要进屋了</p>
<p>​    然后获取到了之后，拿到了openid 和session_key进行获取你的一些需要支付的参数，比如说金额，要买的东西的名称，等等一系列的东西，当然这些东西也是你们后台说的算的。访问你们自己后台的接口。将订单号传进去，拿到一堆你们支付的时候需要用的参数。然后重点来了。也是最恶心的一个东西。就是弄签名，这个签名可不是谁个谁签个名字哦，而是所有参数的联名。下面具体说一下这个签名的过程，并有一堆代码奉上。</p>
<h4 id="六、做签名"><a href="#六、做签名" class="headerlink" title="六、做签名"></a>六、做签名</h4><p>​    首先呢，在拿到了一堆需要的参数以后，将这些参数放到一个对象中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> that = <span class="keyword">this</span>;</div><div class="line">   <span class="keyword">var</span> data = &#123;&#125;;</div><div class="line">   data[<span class="string">"body"</span>] = that.data.goodsName;</div><div class="line">   data[<span class="string">"amount"</span>] = that.data.amount;</div><div class="line">   data[<span class="string">"channelId"</span>] = common.WX_JSAPI;</div><div class="line">   data[<span class="string">"currency"</span>] = common.currency;</div><div class="line">   data[<span class="string">"clientIp"</span>] = common.clientIp;</div><div class="line">   data[<span class="string">"device"</span>] = common.device;</div><div class="line">   data[<span class="string">"extra"</span>] = that.data.openid;</div><div class="line">   data[<span class="string">"mchId"</span>] = common.mchId;</div><div class="line">   data[<span class="string">"mchOrderNo"</span>] = that.data.goodsOrderId;</div><div class="line">   data[<span class="string">"notifyUrl"</span>] = common.notifyUrl;</div><div class="line">   data[<span class="string">"param1"</span>] = <span class="string">""</span>;</div><div class="line">   data[<span class="string">"param2"</span>] = <span class="string">""</span>;</div><div class="line">   data[<span class="string">"subject"</span>] = that.data.goodsOrderId;</div></pre></td></tr></table></figure>
<p>​    大概就像这样吧。（这里是我们后台需要的参数，每个人需要的参数是不同的，所以根据你自己的实际情况来写参数，可以问问你们的后台）;</p>
<p>​    然后呢就是要将这些参数，进行排序，按照字典的顺序排序，也就是abcd的那种。这里是我自己写的一个方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">getSign: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">  <span class="comment">//将上边的那个data，传进来。复制给一个变量中</span></div><div class="line">    <span class="keyword">var</span> M = data;</div><div class="line">	<span class="comment">//然后进行一个排序，下面是一个排序的方法，直接复制走就可以</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">objKeySort</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">      <span class="keyword">var</span> newkey = <span class="built_in">Object</span>.keys(obj).sort();</div><div class="line">      <span class="keyword">var</span> newObj = &#123;&#125;;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; newkey.length; i++) &#123;</div><div class="line">        newObj[newkey[i]] = obj[newkey[i]];</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> newObj;</div><div class="line">    &#125;</div><div class="line">    M = objKeySort(M);</div><div class="line"> <span class="comment">//写一个字符串用于接收，然后将这个排好序的对象，转换成字符串格式。就是 &#123;a=b&amp;c=d&amp;f=g&#125;这样的格式</span></div><div class="line">    <span class="keyword">var</span> str = <span class="string">""</span>;</div><div class="line">  <span class="comment">// 这里是我的项目中需要的一个参数就是extra:&#123;openId:"xxxxxxxx"&#125;,</span></div><div class="line">  <span class="comment">//所以就要写成&#123;...&amp;extra=&#123;"openId":"xxxxxxxx"&#125;&amp;....&#125;这样的格式，所以我做了一个处理，不知道</span></div><div class="line">  <span class="comment">//你们会不会用到</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> M) &#123;</div><div class="line">      <span class="keyword">if</span> (M[k] != <span class="string">""</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (k == <span class="string">"extra"</span>) &#123;</div><div class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> v <span class="keyword">in</span> M[k]) &#123;</div><div class="line">            str += k + <span class="string">'=&#123;"'</span> + v + <span class="string">'":"'</span> + M[k][v] + <span class="string">'"&#125;&amp;'</span>;</div><div class="line">          &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          str += k + <span class="string">"="</span> + M[k] + <span class="string">"&amp;"</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  <span class="comment">//这里需要加一个key，不用去理会他是什么，微信支付规定的，加上就行</span></div><div class="line">    str = str + <span class="string">"key=xJ2hwHmKxbWB3HYzFOKmXf3Bw0VT6SZ4ni2SmK3qgeZUSc43kRoiS5toGdo1YexlakQwzoFEEbY4rgb1k8bPMyDMSj0Ybjklr5A"</span>;</div><div class="line">  <span class="comment">//然后进行md加密。下面我会奉上我的md5，封装好的，拿去就行。</span></div><div class="line">  <span class="comment">//加密了之后再把所有的英文文字转换成大写的。最后生成的这个sign就是签名。很麻烦的</span></div><div class="line">    str = util.hexMD5(str).toUpperCase();</div><div class="line">    <span class="built_in">console</span>.log(str);</div><div class="line">    <span class="keyword">this</span>.setData(&#123;</div><div class="line">      <span class="attr">sign</span>: str</div><div class="line">    &#125;)</div><div class="line">  &#125;,</div></pre></td></tr></table></figure>
<p>成功拿到了签名之后，再和上面所有的参数一起返给后台。后台会进行对比。如果所有的参数都对，尤其是关键的商户号啊，签名啊，订单号啊，等等这些，都没有问题了之后，后台会给你返回一个数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">data:&#123;</div><div class="line"><span class="attr">payOrderId</span>:<span class="string">"P0020181016211322000130"</span>,</div><div class="line"><span class="attr">payParams</span>:&#123;</div><div class="line">	<span class="attr">appId</span>:<span class="string">"wxd626e096a10532ed"</span>,</div><div class="line">	<span class="attr">nonceStr</span>:<span class="string">"1539695602686"</span>,</div><div class="line">	<span class="attr">package</span>:<span class="string">"prepay_id=wx16211322634124ba80c1ced71400103889"</span>,</div><div class="line">	<span class="attr">paySign</span>:<span class="string">"FB3DF8680B1A92BCC2F433AB4A342446"</span>,</div><div class="line">	<span class="attr">signType</span>:<span class="string">"MD5"</span>,</div><div class="line">	<span class="attr">timeStamp</span>:<span class="string">"1539695602"</span></div><div class="line">	&#125;,</div><div class="line"><span class="attr">prepayId</span>:<span class="string">"wx16211322634124ba80c1ced71400103889"</span>,</div><div class="line"><span class="attr">resCode</span>:<span class="string">"SUCCESS"</span>,</div><div class="line"><span class="attr">retCode</span>:<span class="string">"SUCCESS"</span>,</div><div class="line"><span class="attr">retMsg</span>:<span class="string">""</span>,</div><div class="line"><span class="attr">sign</span>:<span class="string">"901C9F215D6452ED04325D6604223503"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>类似于这样的东西，其中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">payParams:&#123;</div><div class="line">	<span class="attr">appId</span>:<span class="string">"wxd626e096a10532ed"</span>,</div><div class="line">	<span class="attr">nonceStr</span>:<span class="string">"1539695602686"</span>,</div><div class="line">	<span class="attr">package</span>:<span class="string">"prepay_id=wx16211322634124ba80c1ced71400103889"</span>,</div><div class="line">	<span class="attr">paySign</span>:<span class="string">"FB3DF8680B1A92BCC2F433AB4A342446"</span>,</div><div class="line">	<span class="attr">signType</span>:<span class="string">"MD5"</span>,</div><div class="line">	<span class="attr">timeStamp</span>:<span class="string">"1539695602"</span></div><div class="line">	&#125;,</div></pre></td></tr></table></figure>
<p> 这些东西才是最后彻底买进门的关键，你此时只需要调取微信的 wx.requestPayment({}) API。然后把参数传进去就行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">wx.requestPayment(&#123;</div><div class="line">       <span class="attr">appId</span>: payParams.appId,</div><div class="line">       <span class="attr">nonceStr</span>: payParams.nonceStr,</div><div class="line">       <span class="attr">package</span>: payParams.package,</div><div class="line">       <span class="attr">paySign</span>: payParams.paySign,</div><div class="line">       <span class="attr">signType</span>: payParams.signType,</div><div class="line">       <span class="attr">timeStamp</span>: payParams.timeStamp,</div><div class="line">       <span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</div><div class="line">         wx.showToast(&#123;</div><div class="line">           <span class="attr">title</span>: <span class="string">"支付成功"</span></div><div class="line">         &#125;)</div><div class="line">         wx.navigateBack(&#123;</div><div class="line">           <span class="attr">delta</span>: <span class="number">1</span>,</div><div class="line">         &#125;)</div><div class="line">       &#125;,</div><div class="line">       <span class="attr">fail</span>: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</div><div class="line">         wx.showToast(&#123;</div><div class="line">           <span class="attr">title</span>: <span class="string">'支付失败'</span>,</div><div class="line">           <span class="attr">icon</span>: <span class="string">"none"</span></div><div class="line">         &#125;)</div><div class="line">       &#125;</div><div class="line">     &#125;)</div></pre></td></tr></table></figure>
<p>这样就结束了。这是前端要做的活，还有很多后台需要做的，很恶心，所以在弄之前，记得和你们后台沟通好，看看他们都需要你们提供什么东西，然后你需要他们给你什么接口，这样省的之后麻烦。</p>
<p>​    这里边最难搞的就是那些参数，然后转换成签名，很容易出错，一个参数不对，签名就不对。所以。。。我就不多说了，自己体会吧</p>
</div></header></article><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2018 SunBoBo</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>